<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafeting 網頁地圖</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mapstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</head>
<body>
    <div class="map-container">
        <div class="search-panel">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="搜尋咖啡廳名稱...">
                <button id="name-search-button" class="search-button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="filter-toggle">
            <button id="filter-toggle-button" class="filter-toggle-button">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>
        <div class="filter-panel" id="filter-panel">
            <div class="filters">
                <select id="outlet-filter">
                    <option value="">插座需求</option>
                    <option value="插座充足">插座充足</option>
                    <option value="部分區域有插座">部分區域有插座</option>
                    <option value="插座數量有限">插座數量有限</option>
                </select>
                <select id="noise-filter">
                    <option value="">安靜程度</option>
                    <option value="安靜環境">安靜環境</option>
                    <option value="音量適中">音量適中</option>
                    <option value="有些吵雜">有些吵雜</option>
                </select>
                <select id="time-filter">
                    <option value="">時間限制</option>
                    <option value="無時間限制">無時間限制</option>
                    <option value="客滿才限時">客滿才限時</option>
                    <option value="有時間限制">有時間限制</option>
                </select>
                <select id="lighting-filter">
                    <option value="">光線程度</option>
                    <option value="光線明亮">光線明亮</option>
                    <option value="光線柔和">光線柔和</option>
                    <option value="光線昏暗">光線昏暗</option>
                </select>
                <select id="seating-filter">
                    <option value="">座位狀況</option>
                    <option value="經常有空位">經常有空位</option>
                    <option value="偶爾需要等待">偶爾需要等待</option>
                </select>
            </div>
            <div class="filter-buttons">
                <button id="filter-search-button" class="filter-button">
                    <i class="fas fa-filter"></i> 套用篩選
                </button>
                <button id="reset-button" class="filter-button reset">
                    <i class="fas fa-undo"></i> 重置
                </button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        const config = {
            googleMapsApiKey: 'AIzaSyAGC0-g81hCy9S2w8c9pbIwqccbaw75dNQ'
        };
    </script>

    <script>
        window.initMap = function() {
            const taipei = { lat: 25.0330, lng: 121.5654 };
            
            const mapStyle = [
            {
        "featureType": "all",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "saturation": 36
            },
            {
                "color": "#b39964"
            },
            {
                "lightness": 40
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.text.stroke",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#000000"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 20
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 17
            },
            {
                "weight": 1.2
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 20
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 21
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 17
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 29
            },
            {
                "weight": 0.2
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 18
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#181818"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 19
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry",
        "stylers": [
            {
                "lightness": 17
            },
            {
                "color": "#525252"
            }
        ]
    }
            ];
            
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 11,
                center: taipei,
                styles: mapStyle,
                disableDefaultUI: true,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                }
            });

            let currentInfoWindow = null;

            const statusColors = {
                outlets: {
                    '插座充足': '#4CAF50',      // 綠色
                    '部分區域有插座': '#FFC107', // 黃色
                    '插座數量有限': '#F44336'    // 紅色
                },
                timeLimit: {
                    '無時間限制': '#4CAF50',
                    '客滿才限時': '#FFC107',
                    '有時間限制': '#F44336'
                },
                lighting: {
                    '光線明亮': '#4CAF50',
                    '光線柔和': '#FFC107',
                    '光線昏暗': '#F44336'
                },
                noise: {
                    '安靜環境': '#4CAF50',
                    '音量適中': '#FFC107',
                    '有些吵雜': '#F44336'
                },
                seating: {
                    '經常有空位': '#4CAF50',
                    '偶爾需要等待': '#FFC107'
                }
            };

            let allMarkers = [];  // 存儲所有標記
            let markerCluster; // 將 markerCluster 移到全局範圍

            function nameSearch() {
                const searchInput = document.getElementById('search-input');
                const searchText = searchInput.value.toLowerCase().trim();
                const matchedMarkers = [];

                // 如果搜尋欄是空的，顯示所有咖啡廳
                if (!searchText) {
                    const bounds = new google.maps.LatLngBounds();
                    allMarkers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    map.fitBounds(bounds);
                    return;
                }

                // 尋找符合的咖啡廳
                allMarkers.forEach(marker => {
                    const cafe = marker.cafe;
                    if (cafe.name.toLowerCase().includes(searchText)) {
                        matchedMarkers.push(marker);
                    }
                });

                // 處理搜尋結果
                if (matchedMarkers.length === 0) {
                    alert('找不到符合的咖啡廳');
                } else {
                    searchInput.value = '';
                    
                    if (matchedMarkers.length === 1) {
                        // 找到一間咖啡廳
                        const marker = matchedMarkers[0];
                        map.setZoom(17);
                        map.panTo(marker.getPosition());
                        
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        google.maps.event.trigger(marker, 'click');
                    } else {
                        // 找到多間咖啡廳
                        const bounds = new google.maps.LatLngBounds();
                        matchedMarkers.forEach(marker => {
                            bounds.extend(marker.getPosition());
                        });
                        map.fitBounds(bounds);
                    }
                }
            }

            function filterSearch() {
                const outletValue = document.getElementById('outlet-filter').value;
                const noiseValue = document.getElementById('noise-filter').value;
                const timeValue = document.getElementById('time-filter').value;
                const lightingValue = document.getElementById('lighting-filter').value;
                const seatingValue = document.getElementById('seating-filter').value;

                const visibleMarkers = [];

                allMarkers.forEach(marker => {
                    const cafe = marker.cafe;
                    let isVisible = true;

                    if (outletValue && cafe.outlets !== outletValue) isVisible = false;
                    if (noiseValue && cafe.noise !== noiseValue) isVisible = false;
                    if (timeValue && cafe.timeLimit !== timeValue) isVisible = false;
                    if (lightingValue && cafe.lighting !== lightingValue) isVisible = false;
                    if (seatingValue && cafe.seating !== seatingValue) isVisible = false;

                    marker.setVisible(isVisible);
                    if (isVisible) {
                        visibleMarkers.push(marker);
                    }
                });

                updateMarkerCluster(visibleMarkers);
            }

            function resetFilters() {
                // 重置所有選擇
                document.getElementById('search-input').value = '';
                document.getElementById('outlet-filter').value = '';
                document.getElementById('noise-filter').value = '';
                document.getElementById('time-filter').value = '';
                document.getElementById('lighting-filter').value = '';
                document.getElementById('seating-filter').value = '';

                // 顯示所有標記
                allMarkers.forEach(marker => marker.setVisible(true));
                updateMarkerCluster(allMarkers);
            }

            function updateMarkerCluster(markers) {
                if (markerCluster) {
                    markerCluster.clearMarkers();
                    markerCluster.addMarkers(markers);
                }
            }

            // 更新事件監聽
            document.getElementById('name-search-button').addEventListener('click', nameSearch);
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    nameSearch();
                }
            });
            document.getElementById('filter-search-button').addEventListener('click', filterSearch);
            document.getElementById('reset-button').addEventListener('click', resetFilters);

            fetch('./cafes.json')
                .then(response => response.json())
                .then(data => {
                    const markers = [];
                    
                    data.cafes.forEach(cafe => {
                        console.log('Cafe data:', cafe);

                        const marker = new google.maps.Marker({
                            position: {
                                lat: cafe.coordinate.latitude,
                                lng: cafe.coordinate.longitude
                            },
                            map: map,
                            title: cafe.name,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: "#00b386",
                                fillOpacity: 1,
                                strokeWeight: 1,
                                strokeColor: "#ffffff",
                                scale: 8
                            }
                        });

                        marker.cafe = cafe;  // 保存咖啡廳��據
                        allMarkers.push(marker);

                        const infoContent = `
                            <div class="cafe-info">
                                <div class="cafe-header">
                                    <h3>${cafe.name || '未知名稱'}</h3>
                                </div>
                                <div class="cafe-details">
                                    <p>
                                        <i class="fas fa-clock"></i>
                                        ${cafe.hours || '未提供營業時間'}
                                    </p>
                                    <p>
                                        <i class="fas fa-map-marker-alt"></i>
                                        ${cafe.address || '未提供地址'}
                                    </p>
                                    ${cafe.phone ? `
                                        <p>
                                            <i class="fas fa-phone"></i>
                                            ${cafe.phone}
                                        </p>
                                    ` : ''}
                                    <div class="status-item">
                                        <i class="fas fa-plug" style="color: ${statusColors.outlets[cafe.outlets]}"></i>
                                        ${cafe.outlets || '未提供資訊'}
                                    </div>
                                    <div class="status-item">
                                        <i class="fas fa-volume-up" style="color: ${statusColors.noise[cafe.noise]}"></i>
                                        ${cafe.noise || '未提供資訊'}
                                    </div>
                                    <div class="status-item">
                                        <i class="fas fa-sun" style="color: ${statusColors.lighting[cafe.lighting]}"></i>
                                        ${cafe.lighting || '未提供資訊'}
                                    </div>
                                    <div class="status-item">
                                        <i class="fas fa-chair" style="color: ${statusColors.seating[cafe.seating]}"></i>
                                        ${cafe.seating || '未提供資訊'}
                                    </div>
                                    <div class="status-item">
                                        <i class="fas fa-hourglass-half" style="color: ${statusColors.timeLimit[cafe.timeLimit]}"></i>
                                        ${cafe.timeLimit || '未提供資訊'}
                                    </div>
                                    ${cafe.website ? `
                                        <div class="cafe-link">
                                            <a href="${cafe.website}" target="_blank">
                                                <i class="fas fa-external-link-alt"></i>
                                                查看店家網站
                                            </a>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;

                        const infoWindow = new google.maps.InfoWindow({
                            content: infoContent,
                            maxWidth: 400,
                            pixelOffset: new google.maps.Size(0, -20),
                            disableAutoPan: false
                        });

                        // 自定義 Info Window 樣式
                        const infoWindowStyles = `
                            .gm-style-iw {
                                padding: 0 !important;
                                background-color: transparent !important;
                                box-shadow: none !important;
                            }
                            .gm-style-iw-d {
                                overflow: hidden !important;
                                padding: 0 !important;
                            }
                            .gm-style-iw-t::after {
                                display: none;
                            }
                        `;

                        const styleSheet = document.createElement('style');
                        styleSheet.type = 'text/css';
                        styleSheet.innerText = infoWindowStyles;
                        document.head.appendChild(styleSheet);

                        marker.addListener('click', () => {
                            if (currentInfoWindow) {
                                currentInfoWindow.close();
                            }
                            infoWindow.open(map, marker);
                            currentInfoWindow = infoWindow;
                        });

                        markers.push(marker);
                    });

                    // 修改 MarkerClusterer 的初始化部分
                    markerCluster = new markerClusterer.MarkerClusterer({
                        map,
                        markers: allMarkers, // 初始時使用所有標記
                        algorithm: new markerClusterer.SuperClusterAlgorithm({
                            radius: 60
                        }),
                        renderer: {
                            render: ({ count, position }) => {
                                return new google.maps.Marker({
                                    position,
                                    label: {
                                        text: String(count),
                                        color: "#ffffff",
                                        fontSize: "13px"
                                    },
                                    icon: {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        scale: 20,
                                        fillColor: "#00b386",
                                        fillOpacity: 0.9,
                                        strokeWeight: 2,
                                        strokeColor: "#ffffff"
                                    },
                                    zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count
                                });
                            }
                        }
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
    <script>
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${config.googleMapsApiKey}&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        }
        window.onload = loadGoogleMapsAPI;
    </script>
    <script>
        // 添加篩選面板切換功能
        document.getElementById('filter-toggle-button').addEventListener('click', function() {
            const filterPanel = document.getElementById('filter-panel');
            filterPanel.classList.toggle('show');
        });

        // 點擊面板外部時關閉面板
        document.addEventListener('click', function(event) {
            const filterPanel = document.getElementById('filter-panel');
            const filterToggle = document.getElementById('filter-toggle-button');
            
            if (!filterPanel.contains(event.target) && 
                !filterToggle.contains(event.target) && 
                filterPanel.classList.contains('show')) {
                filterPanel.classList.remove('show');
            }
        });
    </script>
</body>
</html> 